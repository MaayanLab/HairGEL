<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Zichen Wang (zichen.wang@mssm.edu)">
	<title>Hair-GEL, searchable Gene Expression Library for hair follicles</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/jquery-ui.css">
	<link rel="stylesheet" href="css/barplot.css">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body id="page-top">
	<!-- Navigation -->
<!-- 	<div id="nav">
		<nav class="navbar navbar-inverse" role="navigation">
			<div class="container-fluid">
				<div class="navbar-header page-scroll">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand page-scroll" href="#page-top">Hair-GEL</a>
				</div>
				<div class="collapse navbar-collapse navbar-ex1-collapse">
					<ul class="nav navbar-nav">
						<li class="hidden">
							<a class="page-scroll" href="#page-top"></a>
						</li>
						<li>
							<a class="page-scroll" href="#genes">Query genes</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>
	</div> -->

	<div class="container-fluid">
		<div class="row" id="top-banner">
			<div class="col-lg-10 col-lg-offset-1 translucent-padding" >
				<div class="row" id="big-logo">
					<div class="col-sm-6"><h1 class="large-font">Hair-GEL</h1></div>
					<div class="col-sm-3" id="top-middle">
						<p class="medium-font"> <span class="black-words">searchable</span><br>
							<u>G</u>ene <u>E</u>xpression <u>L</u>ibrary<br>
							<span class="black-words">for hair follicles</span>
						</p>
					</div>
					<div class="col-sm-3 text-center" id="logos">
						<a href="http://icahn.mssm.edu/"><img src="img/MSSMLogo.png"></a><br>
						<a href="http://research.mssm.edu/rendl/">Rendl Lab</a>
						<a href="http://icahn.mssm.edu/research/labs/maayan-laboratory">Ma'ayan Lab</a>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-10 col-lg-offset-1 translucent-padding">
				<div class="row">
					<div class="col-lg-6 text-center">
						<div class="form-inline">
							<h3>E14.5 embryonic mouse skin</h3>
							<div class="form-group">
								<label for="gene" class="control-label">gene query:</label>
								<input type="text" id="gene" class="form-control ui-autocomplete-input" aria-describedby="gene-hint" />
							</div>
							<button class="btn btn-info" id="go-button"><span class="glyphicon glyphicon-search"></span> Search</button>
							
							<span id="gene-hint" class="help-block">Search for gene of interest by entering official symbol</span>
						</div>
						<span class="right-align">* signature genes</span>
						<div>
							<div id="barplot-container"></div>
							<button class="btn btn-info" id="save-button"><span class="glyphicon glyphicon-save-file"></span> Save image</button>
						</div>
					</div>
					<div class="col-lg-6 text-center">
						<img id="legend" width="440" src="img/Cartoon_new.svg">
						<div>
							<h3><i>FPKMs:</i></h3>
							<div id="fpkm-table" class="table-responsive"></div>
						</div>
					</div>
				</div>
			</div>
		</div>		

		<div class="row">
			<div class="col-lg-10 col-lg-offset-1 translucent-padding text-center" id="links">
				<table>
					<tbody>
						<tr>
							<td><a href="downloads/FPKMs all genes.xls" target="_blank"><span class="glyphicon glyphicon-download-alt"></span> download FPKMs</a></td>
							<td><a href="downloads/GO analysis Fig4.xls" target="_blank"><span class="glyphicon glyphicon-download-alt"></span> download signature gene lists</a></td>
							<td><a href="" target="_blank"><span class="glyphicon glyphicon-new-window"></span> GEO data</a></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div class="row footer">
			<div class="col-lg-10 col-lg-offset-1">
				<span><i>Please cite: Sennett et al. Dev Cell (2015)</i> <br>A Transcriptome Atlas of Embryonic Hair Follicle Progenitors, Their Niche and the Developing Skin </span>
			</div>
		</div>
	</div> <!-- end of container -->

	<!-- JavaScripts -->
	<script src="js/jquery.js"></script>
	<script src="js/jquery-ui.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/d3.v3.min.js"></script>
	<script src="js/saveSvgAsPng.js"></script>
	<script>
	// for barplot
	var margin = {top: 40, right: 10, bottom: 25, left: 50},
	width = 500 - margin.left - margin.right,
	height = 300 - margin.top - margin.bottom;

	var x = d3.scale.ordinal()
	.rangeRoundBands([0, width], .1);

	var y = d3.scale.linear()
	.range([height, 0]);

	var xAxis = d3.svg.axis()
	.scale(x)
	.orient("bottom")
	.tickSize(10,10);

	var yAxis = d3.svg.axis()
	.scale(y)
	.orient("left")

	var svg = d3.select("#barplot-container").append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.attr("id", "fpkm-barplot")
	.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	$(document).ready(function(){ // preload a bargraph
		$.getJSON('genes.php', {gene: 'Dkk4'}, function(json){
			barPlot(json);
			fpkmTable(json);
		})
	})

	$('#gene').bind("enterKey",function(e){
		var geneInput = $(this).val();
		$.getJSON('genes.php', {gene: geneInput}, function(json){
			barPlot(json);
			fpkmTable(json);
		})
	});

	$('#go-button').click(function(){
		var geneInput = $('#gene').val();
		$.getJSON('genes.php', {gene: geneInput}, function(json){
			barPlot(json);
			fpkmTable(json);
		})
	})

	$('#gene').keyup(function(e){
		if(e.keyCode == 13) {
			$(this).trigger("enterKey");
		}
	});

	var sampleNames = {
		C6 :'Pc' ,
		C7 :'Epi' ,
		C8 :'Mc' ,
		C4 :'DC' ,
		C1 :'Fb' ,
		C5 :'Sch' ,
		C3 :'DC/Sch' ,
		C2 :'EC/SM' ,
	};

	// table
	function fpkmTable(json) {
		d3.select("#fpkm-table-gene").remove()
		var table = d3.select("#fpkm-table").append("table")
		.attr('id', 'fpkm-table-gene')
		.attr('class', 'table table-bordered table-condensed');
		data = json['data'];
		for (var i = 0; i < data.length; i++) {
			data[i]['sampleName'] = sampleNames[data[i].name];
		};
		var theads = table.append("thead").append("tr")
		.selectAll("th").data(data)
		.enter().append("th")
		.text(function(d) { return d.sampleName; } )
		var trs = table.append("tbody").append("tr")
		.selectAll("td").data(data)
		.enter().append("td")
		.text(function(d){ return parseFloat(d.avg).toFixed(1); })
	}

	function barPlot(json) {
		d3.select("#title").remove();
		d3.select("#x-axis").remove();
		d3.select("#y-axis").remove();
		d3.selectAll(".mouseover-title").remove()
		data = json['data'];
		for (var i = 0; i < data.length; i++) {
			data[i]['sampleName'] = sampleNames[data[i].name];
		};
		x.domain(data.map(function(d) { return d.sampleName; }));
		y.domain([0, 1.25*d3.max(data, function(d) { return parseFloat(d.avg); })]);
		// set up xAxis
		svg.append("g")
		.attr("class", "x axis")
		.attr("id", "x-axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);
		// set up yAxis
		svg.append("g")
		.attr("class", "y axis")
		.attr("id", "y-axis")
		.call(yAxis)
		.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.style("font-size", "16px")
		.text("FPKM");

		// plot bars
		var rects = svg.selectAll("rect").data(data);
		rects.enter().append("rect")
		.attr("class", function(d) {return d.name; })
		.attr("x", function(d) { return x(d.sampleName); })
		.attr("width", x.rangeBand())
		.attr("y", function(d) { return y(d.avg); })
		.attr("height", function(d) { return height - y(d.avg); })

		rects.transition()
		.duration(1000)
		.attr("y", function(d) { return y(d.avg); })
		.attr("height", function(d) { return height - y(d.avg); });

		rects.append('title')
		.attr("class", "mouseover-title")
		.text(function(d){ return 'FPKM: ' + parseFloat(d.avg).toFixed(1); });

		rects.exit().remove();

		// add error bars
		var errorBars = svg.selectAll(".errorBar").data(data);
		errorBars.enter().append("path")
		.attr("class", 'errorBar')
		.attr("d", function(d){
			var barWidth = 0.5*x.rangeBand();
			var xVal = x(d.sampleName)+barWidth;
			var upper = parseFloat(d.avg) + parseFloat(d.sd),
			lower = parseFloat(d.avg) - parseFloat(d.sd);
			return "M"+xVal+","+y(lower)+ "L"+xVal+","+y(d.avg) +"L"+xVal+','+y(upper);
		});

		errorBars.transition().duration(1000)
		.attr("d", function(d){
			var barWidth = 0.5*x.rangeBand();
			var xVal = x(d.sampleName)+barWidth;
			var upper = parseFloat(d.avg) + parseFloat(d.sd),
			lower = parseFloat(d.avg) - parseFloat(d.sd);
			return "M"+xVal+","+y(lower)+ "L"+xVal+","+y(d.avg) +"L"+xVal+','+y(upper);
		});

		errorBars.exit().remove();

		// add title
		var title = svg.append("text")
		.attr("x", width / 2 )
		.attr("y", 0)
		.attr('id', 'title')
		.style("text-anchor", "middle")
		.style("font-size", "20px")
		.text(function(){
			if (json['signature']) {
				return json['gene'] + '*';
			}else {
				return json['gene'];
			}
		});
	}

// autocomplete
$.getJSON("geneNames.json",function(data){
	$(function() {
		$( "#gene" ).autocomplete({
			minLength: 3,
			source: data,
		});
	});
});

d3.select("#save-button").on("click", function(){
	saveSvgAsPng(document.getElementById("fpkm-barplot"), "fpkm-barplot.png"); 
});

</script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-60506844-1', 'auto');
ga('send', 'pageview');

</script>
</body>
</html>
